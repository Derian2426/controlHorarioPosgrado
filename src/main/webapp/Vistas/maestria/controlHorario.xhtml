<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="./../../WEB-INF/HeaderFooterPrincipal.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core">
    <ui:define name="titulo">
        Control de Horarios
    </ui:define>
    <ui:define name="content">
        <div class="card" style="position: initial">
            <h:form id="form_horario"> 
                <h:outputStylesheet library="webjars" name="primeflex/3.2.0/primeflex.min.css" />
                <p:growl id="messages" showDetail="true"/>
                <div class="card">
                    <p:tabView id="planificacionHorario">
                        <p:tab title="Planificación Periodo">
                            <p:toolbar>
                                <p:toolbarGroup>
                                    <p:commandButton id="dynaButton" value="Planificación del Periodo" type="button" icon="pi pi-bars"/>
                                    <p:menu overlay="true" trigger="dynaButton" my="left top" at="left bottom">
                                        <p:submenu label="Opciones">
                                            <p:menuitem value="Nuevo Periodo Académico" icon="pi pi-plus"
                                                        onclick="PF('dlgPlanificacion').show()"/>
                                        </p:submenu>
                                    </p:menu>
                                </p:toolbarGroup>
                            </p:toolbar>
                            <p:outputPanel id="HorarioPeriodo" class="ui-fluid">
                                <p:dataTable id="horarioPeriodo" var="periodo" rows="5" paginator="true" paginatorPosition="bottom" value="#{GeneradorHorarioMB.listaPeriodo}">
                                    <f:facet name="header">
                                        Periodos Académicos 
                                    </f:facet>

                                    <p:column headerText="Nombre de la Maestría">
                                        <h:outputText value="#{periodo.nombrePeriodo}" />
                                    </p:column>
                                    <p:column headerText="Fecha Inicio">
                                        <h:outputText value="#{periodo.fechaInicio}" />
                                    </p:column>
                                    <p:column headerText="Fecha Fin">
                                        <h:outputText value="#{periodo.fechaFin}" />
                                    </p:column>
                                    <p:column headerText="Acciones">
                                        <p:commandButton id="accionesPeriodo" value="Acciones" type="button" icon="pi pi-chevron-down" styleClass="ui-button-outlined" />
                                        <p:menu overlay="true" trigger="accionesPeriodo" my="left top" at="left bottom">
                                            <p:submenu label="Acciones">
                                                <p:menuitem value="Detalle" icon="pi pi-file-o"/>
                                                <p:menuitem value="Editar" icon="pi pi-pencil"/>
                                            </p:submenu>
                                        </p:menu>
                                    </p:column>
                                </p:dataTable>
                            </p:outputPanel>
                            <p:dialog header="Planificación Periodo" widgetVar="dlgPlanificacion" minHeight="100" width="650" showEffect="fade" modal="true" responsive="true" position="center" closable="false">
                                <p:outputPanel id="nuevoPerido" class="ui-fluid">
                                    <div class="ui-fluid p-formgrid p-grid">
                                        <div class="p-field p-col-12 p-md-8">
                                            <p:outputLabel value="Nombre Maestría"/>
                                            <p:inputText maxlength="150" value="#{GeneradorHorarioMB.integracionMaestria.nombre}" readonly="true"/>
                                        </div>
                                        <div class="p-field p-col-12 p-md-4">
                                            <p:outputLabel value="." style="color: white" />
                                            <p:commandButton style="margin-right: 6px;" value="Buscar Maestría" 
                                                             styleClass="ui-button-secondary" icon="pi pi-search" oncomplete="PF('listMaestriaPeriodoP').show()">
                                            </p:commandButton>
                                        </div>

                                        <p:outputLabel value="Descripción:"/>
                                        <p:inputTextarea maxlength="200" rows="3" cols="3" value="#{GeneradorHorarioMB.periodo.nombrePeriodo}"/>
                                        <div class="p-field p-col-12 p-md-6">
                                            <p:outputLabel value="Fecha de inicio:"/>
                                            <p:calendar value="#{GeneradorHorarioMB.periodo.fechaInicio}" />
                                        </div>
                                        <div class="p-field p-col-12 p-md-6">
                                            <p:outputLabel value="Fecha de finalización:"/>
                                            <p:calendar value="#{GeneradorHorarioMB.periodo.fechaFin}" />
                                        </div>

                                        <div class="p-field p-col-12 p-md-6">
                                            <p:outputLabel value="Paralelo:"/>
                                            <p:selectOneMenu id="paralelo" value="#{GeneradorHorarioMB.periodo.nombreParalelo}">
                                                <p:ajax update="@this" process="@this"/>
                                                <f:selectItem itemLabel="A" itemValue="A"/>
                                                <f:selectItem itemLabel="B" itemValue="B"/>
                                                <f:selectItem itemLabel="C" itemValue="C"/>
                                                <f:selectItem itemLabel="D" itemValue="D"/>
                                            </p:selectOneMenu>
                                        </div>
                                        <div class="p-field p-col-12 p-md-6">
                                            <p:outputLabel value="Cantidad de estudiantes:"/>
                                            <p:inputNumber value="#{GeneradorHorarioMB.periodo.cantidadEstudiante}" />
                                        </div>

                                        <div class="p-field p-col-12 p-md-6">
                                            <p:commandButton value="Guardar " icon="pi pi-check" styleClass="ui-button-success" actionListener="#{GeneradorHorarioMB.registrarPeriodo()}" action="#{horarioMB.actualizaListas()}"
                                                             update=":form_horario:messages ,:form_horario:planificacionHorario:nuevoPerido,:form_horario:planificacionHorario:horarioPeriodo,:form_horario:planificacionHorario:dtSeleccionMaestriaPeriodo,:form_horario:planificacionHorario:horarioMaestria"/>
                                        </div>
                                        <div class="p-field p-col-12 p-md-6">
                                            <p:commandButton value="Cancelar " icon="pi pi-times" styleClass="ui-button-primary" class="ui-button-danger p-mr-2 p-mb-2" actionListener="#{GeneradorHorarioMB.cancelarPeriodo()}" 
                                                             onclick="PF('dlgPlanificacion').hide()" update=":form_horario:messages ,:form_horario:planificacionHorario:nuevoPerido"/>
                                        </div>
                                    </div>

                                </p:outputPanel>
                            </p:dialog>

                            <p:dialog header="Seleccione una de las  Maestrías" widgetVar="listMaestriaPeriodoP" minHeight="300" width="800" showEffect="fade" modal="true" responsive="true">
                                <div class="card">
                                    <p:dataTable id="dtSeleccionMaestriaPeriodoP" var="maestrias" value="#{GeneradorHorarioMB.listaMaestriaPeriodo}" editable="true" paginatorPosition="bottom"
                                                 style="margin-bottom:20px" reflow="true" rows="3" paginator="true"
                                                 emptyMessage="No se encontro la maestría">
                                        <f:facet name="header">
                                            <span class="ui-input-icon-left">
                                                <p:inputText placeholder="Buscar Maestría" value="#{GeneradorHorarioMB.maestriaBusqueda.nombre}" style="margin-right: 6px">
                                                </p:inputText>
                                                <p:commandButton icon="pi pi-search" update=":form_horario:planificacionHorario:dtSeleccionMaestriaPeriodoP" styleClass="rounded-button ui-button-secondary" actionListener="#{GeneradorHorarioMB.buscarMaestriaPeriodo()}" 
                                                                 process="dtSeleccionMaestriaPeriodoP @this"/>
                                            </span>
                                        </f:facet>
                                        <p:column headerText="Acciones" style="width:6rem">
                                            <p:commandButton
                                                class="rounded-button"
                                                icon="pi pi-check">
                                                <p:ajax listener="#{GeneradorHorarioMB.llenaMaestriaPeriodo(maestrias)}" 
                                                        update=":form_horario:messages ,:form_horario:planificacionHorario:nuevoPerido"
                                                        oncomplete="PF('listMaestriaPeriodoP').hide()"/>

                                            </p:commandButton>
                                        </p:column>
                                        <p:column headerText="Nombre Maestría" style="text-align: justify">
                                            <h:outputText value="#{maestrias.nombre}"/>
                                        </p:column>

                                        <p:column headerText="Descripción" style="text-align: justify">
                                            <h:outputText value="#{maestrias.descripcion}"/>
                                        </p:column>
                                    </p:dataTable>
                                </div>
                            </p:dialog>
                        </p:tab>
                        <p:tab title="Planificación de Horarios">

                            <p:outputPanel id="nuevaPerido" class="ui-fluid">
                                <div class="card">
                                    <div class="ui-fluid formgrid grid">
                                        <div class="field col-12 md:col-6">
                                            <p:toolbar>
                                                <p:toolbarGroup>
                                                    <p:staticMessage severity="info" summary="Informativo" detail="Planifique el perido por maestría en caso de no tener la maestría disponible para la planificaión del horario." style="width: 100%"/>
                                                    <div class="p-field p-md-12">
                                                        <span style="font-weight: bold; 
                                                              font-size: 24px">Planificación de Horarios</span>
                                                    </div>
                                                    <div class="ui-fluid formgrid grid">
                                                        <div class="field col-12 md:col-8">
                                                            <p:outputLabel for="@next" value="Nombre Maestría" />
                                                            <p:inputText maxlength="150" value="#{horarioMB.integracionMaestria.nombre}" readonly="true" style="margin-right: 1vh;"/>
                                                        </div>
                                                        <div class="field col-12 md:col-4">
                                                            <p:outputLabel for="@next" value="." />
                                                            <p:commandButton value="Buscar Maestría" 
                                                                             styleClass="ui-button-secondary" icon="pi pi-search" oncomplete="PF('listMaestriaPeriodo').show()"/>
                                                        </div>
                                                        <div class="field col-12 md:col-12">
                                                            <p:outputLabel value="Descripción:"/>
                                                            <p:inputTextarea maxlength="200" rows="2" cols="5" value="#{horarioMB.integracionMaestria.descripcion}" readonly="true"/>
                                                        </div>
                                                        <div class="field col-12 md:col-6">
                                                            <p:outputLabel value="Fecha de inicio:"/>
                                                            <p:calendar value="#{horarioMB.integracionMaestria.fechaInicio}" readonly="true"/>
                                                        </div>
                                                        <div class="field col-12 md:col-6">
                                                            <p:outputLabel value="Fecha de finalización:"/>
                                                            <p:calendar value="#{horarioMB.integracionMaestria.fechaFin}" readonly="true"/>
                                                        </div>
                                                    </div>
                                                </p:toolbarGroup>
                                            </p:toolbar>
                                        </div>
                                        <div class="field col-12 md:col-6">
                                            <p:schedule timeZone="GMT-5" locale="es" id="calendarioAcademico" draggable="false" value="#{horarioMB.eventModel}" rightHeaderTemplate="dayGridMonth" 
                                                        initialDate="#{horarioMB.periodo.fechaInicio}">
                                                <p:ajax event="dateSelect" listener="#{horarioMB.onDateSelect}" update=":form_horario:planificacionHorario:nuevoDocenteAsignado,:form_horario:messages ,:form_horario:planificacionHorario:nuevaPerido,:form_horario:planificacionHorario:calendarioAcademico" process="nuevaPerido @this"/>
                                                <p:ajax event="eventSelect" listener="#{horarioMB.onEventSelect}" update=":form_horario:planificacionHorario:editDocenteAsignado,:form_horario:messages ,:form_horario:planificacionHorario:nuevaPerido,:form_horario:planificacionHorario:calendarioAcademico" process="nuevaPerido @this"
                                                        oncomplete="PF('seleccionEditFecha').show();"/>
                                            </p:schedule>
                                        </div>
                                    </div>
                                </div>
                            </p:outputPanel>
                            <p:dialog header="Seleccione una de las  Maestrías" widgetVar="listMaestriaPeriodo" minHeight="300" width="800" showEffect="fade" modal="true" responsive="true">
                                <div class="card">
                                    <p:dataTable id="dtSeleccionMaestriaPeriodo" var="maestrias" value="#{horarioMB.listaMaestria}" editable="true" paginatorPosition="bottom"
                                                 style="margin-bottom:20px" reflow="true" rows="2" paginator="true"
                                                 emptyMessage="No se encontro la maestría">
                                        <f:facet name="header">
                                            <span class="ui-input-icon-left">
                                                <p:inputText placeholder="Buscar Maestría" value="#{horarioMB.maestriaBusqueda.nombre}" style="margin-right: 6px">
                                                </p:inputText>
                                                <p:commandButton icon="pi pi-search" update=":form_horario:planificacionHorario:dtSeleccionMaestriaPeriodo" styleClass="rounded-button" actionListener="#{horarioMB.buscarMaestria()}" process="dtSeleccionMaestriaPeriodo @this"/>
                                            </span>
                                        </f:facet>
                                        <p:column headerText="Acciones" style="width:6rem">
                                            <p:commandButton
                                                class="rounded-button"
                                                icon="pi pi-check">
                                                <p:ajax listener="#{horarioMB.llenaMaestriaPeriodo(maestrias)}" 
                                                        update=":form_horario:planificacionHorario:nuevaPerido,:form_horario:messages,:form_horario:planificacionHorario:nuevoDocenteAsignado,:form_horario:planificacionHorario:calendarioAcademico"
                                                        oncomplete="PF('listMaestriaPeriodo').hide()"/>
                                            </p:commandButton>
                                        </p:column>
                                        <p:column headerText="Nombre Maestría" style="text-align: justify">
                                            <h:outputText value="#{maestrias.nombre}"/>
                                        </p:column>
                                        <p:column headerText="Fecha Inicio" style="text-align: justify">
                                            <h:outputText value="#{maestrias.fechaInicio}"/>
                                        </p:column>
                                        <p:column headerText="Fecha Fin" style="text-align: justify">
                                            <h:outputText value="#{maestrias.fechaFin}"/>
                                        </p:column>
                                    </p:dataTable>
                                </div>
                            </p:dialog>
                            <p:dialog widgetVar="seleccionFecha" header="Asignación Horario" showEffect="fade" height="50%" width="50%" modal="true" responsive="true">
                                <p:ajax event="close" listener="#{horarioMB.cerrarDialigo()}" update=":form_horario:planificacionHorario:nuevoDocenteAsignado"/>
                                <p:outputPanel id="nuevoDocenteAsignado" class="ui-fluid">
                                    <p:outputLabel value="Módulos" for="@next" styleClass="p-text-bold"/>
                                    <p:selectOneMenu editable="false" value="#{horarioMB.modulo.idMateria}" disabled="#{horarioMB.estadoAsignacion}">
                                        <f:selectItem itemLabel="Seleccione un Módulo" noSelectionOption="true"/>
                                        <f:selectItems value="#{horarioMB.listaModulo}" var="moduloAsignado" 
                                                       itemLabel="#{moduloAsignado.nombreMateria}" 
                                                       itemValue="#{moduloAsignado.idMateria}"></f:selectItems>
                                    </p:selectOneMenu>
                                    <p:outputLabel value="Docentes" for="@next" styleClass="p-text-bold"/>
                                    <p:selectOneMenu editable="false" disabled="#{horarioMB.estadoAsignacion}" value="#{horarioMB.docente.id_docente}">
                                        <f:selectItem itemLabel="Seleccione un Docente" noSelectionOption="true"/>
                                        <f:selectItems value="#{horarioMB.listaDocente}" var="docenteAsignado" 
                                                       itemLabel="#{docenteAsignado.nombre_docente}" 
                                                       itemValue="#{docenteAsignado.id_docente}"></f:selectItems>
                                        <p:ajax listener="#{horarioMB.obtenerValidacionHorario}" update=":form_horario:planificacionHorario:nuevoDocenteAsignado" process="nuevoDocenteAsignado @this"/>
                                    </p:selectOneMenu>
                                    <p:outputLabel value="Descripción:" styleClass="p-text-bold"/>
                                    <p:inputTextarea maxlength="200" rows="2" cols="5" value="#{horarioMB.tiempoModulo.descripcion}" disabled="#{horarioMB.estadoAsignacion}"/>
                                    <p:outputLabel value="Fecha de asignación:" styleClass="p-text-bold"/>
                                    <p:datePicker value="#{horarioMB.tiempoModulo.fechaAsignacion}" pattern="yyyy/dd/MM" style="margin-bottom: 1vh;" disabled="true"/>




                                    <p:outputLabel value="Fechas disponibles para las asignaciones:" styleClass="p-text-bold"/>

                                    <div class="ui-fluid formgrid grid">
                                        <div class="field col-12 md:col-9">
                                            <p:pickList id="pickList" value="#{horarioMB.tiempoHorario}" var="fechaPeriodo" itemLabel="#{fechaPeriodo}" itemValue="#{fechaPeriodo}" responsive="true">
                                                <p:ajax event="transfer" listener="#{horarioMB.onTransfer}"/>
                                                <f:facet name="sourceCaption">Fechas disponibles</f:facet>
                                                <f:facet name="targetCaption">Fechas asignadas</f:facet>
                                            </p:pickList>
                                        </div>
                                        <div class="field col-12 md:col-3">
                                            <div class="ui-fluid formgrid grid">
                                                <div class="field col-12 md:col-12">
                                                    <p:commandButton id="fechaBtnDocente" value="Fechas de asignaciones del docente" type="button" icon="pi pi-calendar"/>
                                                    <p:overlayPanel for="fechaBtnDocente" dynamic="true" style="width:25%">
                                                        <p:dataTable var="fechaDocenteAsignada" value="#{horarioMB.listaVerificacionTiempo}" rows="5" paginator="true">
                                                            <p:column headerText="Fecha de asignación">
                                                                <h:outputText value="#{fechaDocenteAsignada.fechaAsignacion}"/>
                                                            </p:column>
                                                        </p:dataTable>
                                                    </p:overlayPanel>
                                                    <p:tooltip for="fechaBtnDocente" value="Puede visualizar las fechas que el docente ya tiene asignadas." showEffect="clip" hideEffect="fold" />
                                                </div>
                                                <div class="field col-12 md:col-12">
                                                    <p:commandButton id="fechaBtnMaestria" value="Fechas de asignaciones de la maestría" type="button" icon="pi pi-calendar" />
                                                    <p:overlayPanel for="fechaBtnMaestria" dynamic="true" style="width:25%">
                                                        <p:dataTable var="fechaMaestriaAsignada" value="#{horarioMB.listaHorario}" rows="5" paginator="true">
                                                            <p:column headerText="Maestría">
                                                                <h:outputText value="#{horarioMB.integracionMaestria.nombre}"/>
                                                            </p:column>
                                                            <p:column headerText="Fecha de asignación">
                                                                <h:outputText value="#{fechaMaestriaAsignada.fechaInicio}"/>
                                                            </p:column>
                                                        </p:dataTable>
                                                    </p:overlayPanel>
                                                    <p:tooltip for="fechaBtnMaestria" value="Puede visualizar las fechas que ya estan asignadas para la maestría." showEffect="clip" hideEffect="fold" />
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <p:commandButton actionListener="#{horarioMB.registrarPeriodo()}" action="#{GeneradorHorarioMB.actualizaLista()}" value="Guardar" process="nuevoDocenteAsignado @this" styleClass="p-text-bold ui-button-outlined" 
                                                     update=":form_horario:planificacionHorario:calendarioAcademico,:form_horario:planificacionHorario:nuevoDocenteAsignado,:form_horario:messages,mensajeEstatico,:form_horario:planificacionHorario:horarioMaestria" style="margin-bottom: 1vh;"/>
                                    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                                        <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-flat"/>
                                        <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes" />
                                    </p:confirmDialog>
                                </p:outputPanel>
                            </p:dialog>
                            <p:dialog header="Transacción Fallida" widgetVar="transaccion" minHeight="40" width="550" showEffect="fade" modal="true">
                                <div class="ui-fluid formgrid grid">
                                    <div class="field col-12 md:col-6">
                                        <p:staticMessage id="mensajeEstatico" severity="error" summary="ERROR" detail="#{horarioMB.mensaje}" style="width: 100%"/>

                                    </div>
                                    <div class="field col-12 md:col-6">
                                        <p:staticMessage severity="info" summary="INFORMACIÓN" detail="Esté error surge por que al momneto de realizar la asignación, otro usuario ocupo primero que usted las fecha disponibles del docente, por favor vuelva asignar las fechas al docente, asegurese de que no se registren asignaciones por otro usuario." style="width: 100%"/>
                                    </div>
                                </div>
                            </p:dialog>
                            <p:dialog widgetVar="seleccionEditFecha" header="Asignación Horario" showEffect="fade" height="50%" width="50%" modal="true" responsive="true">
                                <p:outputPanel id="editDocenteAsignado" class="ui-fluid">
                                    <p:outputLabel value="Módulo" for="@next" styleClass="p-text-bold"/>
                                    <p:inputText value="#{horarioMB.modulo.nombreMateria}" readonly="true"/>
                                    <p:outputLabel value="Docente" for="@next" styleClass="p-text-bold"/>
                                    <p:inputText value="#{horarioMB.docente.nombre_docente}" readonly="true"/>
                                    <p:outputLabel value="Descripción:" styleClass="p-text-bold"/>
                                    <p:inputTextarea maxlength="200" rows="2" cols="5" value="#{horarioMB.tiempoModulo.descripcion}" readonly="true"/>
                                    <p:outputLabel value="Fecha de asignación:" styleClass="p-text-bold"/>
                                    <p:datePicker value="#{horarioMB.tiempoModulo.fechaAsignacion}" pattern="yyyy/dd/MM" style="margin-bottom: 1vh;" disabled="true"/>
                                </p:outputPanel>
                            </p:dialog>
                        </p:tab>
                        <p:tab title="Horarios">
                            <p:outputPanel id="HorarioGenerador" class="ui-fluid">
                                <p:dataTable id="horarioMaestria" var="horario" value="#{GeneradorHorarioMB.listaMaestria}" rows="5" paginator="true" paginatorPosition="bottom">
                                    <f:facet name="header">
                                        CALENDARIO ACADEMICO
                                    </f:facet>

                                    <p:column headerText="Nombre de la Maestría">
                                        <h:outputText value="#{horario.nombre}" />
                                    </p:column>
                                    <p:column headerText="Fecha Inicio">
                                        <h:outputText value="#{horario.fechaInicio}" />
                                    </p:column>
                                    <p:column headerText="Fecha Fin">
                                        <h:outputText value="#{horario.fechaFin}" />
                                    </p:column>
                                    <p:column headerText="Estado" sortBy="#{horario.estado}">
                                        <p:tag severity="success" value="#{horario.estado}" rendered="#{horario.estado eq 'Activo'}"/>
                                        <p:tag value="#{horario.estado}" rendered="#{horario.estado eq 'Planificado'}"/>
                                        <p:tag severity="danger" value="#{horario.estado}" rendered="#{horario.estado eq 'Terminado'}"/>
                                    </p:column>
                                    <p:column headerText="Archivo">
                                        <p:commandButton value="Descargar" icon="pi pi-download" styleClass="ui-button-outlined ui-button-success" 
                                                         action="#{GeneradorHorarioMB.generarArchivoExcel(horario.idCurso,horario.nombre,horario.fechaInicio,horario.fechaFin)}" ajax="false"/>
                                    </p:column>
                                    <p:column headerText="Acciones">
                                        <p:commandButton id="accionesHorario" value="Acciones" type="button" icon="pi pi-chevron-down" styleClass="ui-button-outlined" />
                                        <p:menu overlay="true" trigger="accionesHorario" my="left top" at="left bottom">
                                            <p:submenu label="Acciones">
                                                <p:menuitem value="Detalle" icon="pi pi-file-o"/>
                                                <p:menuitem value="Editar" icon="pi pi-pencil"/>

                                            </p:submenu>
                                        </p:menu>
                                    </p:column>
                                </p:dataTable>
                            </p:outputPanel>
                        </p:tab>
                    </p:tabView>
                </div>
            </h:form>
        </div>
    </ui:define>

</ui:composition>
